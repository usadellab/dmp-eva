<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMP Evaluation Tool</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <header class="py-4 mb-4 border-bottom">
            <div class="d-flex align-items-center">
                <i class="fas fa-clipboard-check fa-2x text-primary me-3"></i>
                <h1 class="h2 mb-0">DMP Evaluation Tool</h1>
            </div>
            <p class="text-muted mb-0">AI-powered Data Management Plan evaluation using Together.ai</p>
        </header>

        <div class="row">
            <!-- Left Column: Configuration & Upload -->
            <div class="col-lg-5 scrollable-column">
                <!-- API Configuration Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cog me-2"></i>API Configuration</h5>
                    </div>
                    <div class="card-body">
                        <!-- API Key -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="togetherAPIKey" class="form-label mb-0">Together.ai API Key</label>
                                <button class="btn btn-sm btn-outline-primary" type="button" id="openAPIConfigBtn">
                                    <i class="fas fa-sliders-h me-1"></i>API Config
                                </button>
                            </div>
                            <div class="input-group">
                                <input type="password" class="form-control" id="togetherAPIKey"
                                       placeholder="Enter your API key">
                                <button class="btn btn-outline-secondary" type="button" id="toggleAPIKey">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Get your API key from <a href="https://api.together.xyz/" target="_blank">Together.ai</a>
                            </small>
                        </div>

                        <!-- Model Selection -->
                        <div class="mb-3">
                            <label for="togetherAIModel" class="form-label">Primary Model</label>
                            <select class="form-select" id="togetherAIModel">
                                <option value="Qwen/Qwen3-235B-A22B-Instruct-2507-tput">Qwen3 235B Instruct</option>
                                <option value="openai/gpt-oss-20b">GPT OSS 20B</option>
                                <option value="openai/gpt-oss-120b">GPT OSS 120B</option>
                                <option value="deepseek-ai/DeepSeek-R1-0528-tput">DeepSeek R1</option>
                            </select>
                        </div>

                        <!-- Test Mode -->
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="llmTestMode">
                            <label class="form-check-label" for="llmTestMode">
                                Test Mode (use sample data, no API calls)
                            </label>
                        </div>

                        <!-- Project Phase -->
                        <div class="mb-3">
                            <label for="projectPhase" class="form-label">Project Phase</label>
                            <select class="form-select" id="projectPhase">
                                <option value="proposal">Proposal / Early Stage</option>
                                <option value="mid">Mid-Project</option>
                                <option value="end">End-Project</option>
                            </select>
                            <small class="form-text text-muted">Select the project phase to evaluate against</small>
                        </div>
                    </div>
                </div>

                <!-- File Upload Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload Files</h5>
                    </div>
                    <div class="card-body">
                        <!-- Evaluation Criteria Upload -->
                        <div class="mb-4">
                            <label class="form-label">Evaluation Criteria Document</label>
                            <div class="upload-zone" id="criteriaUploadZone">
                                <i class="fas fa-file-alt fa-3x mb-3 text-muted"></i>
                                <p class="mb-2">Drag & Drop or Click to Upload</p>
                                <small class="text-muted">Supports: .docx, .doc, .txt, .json, .pdf, .md</small>
                                <input type="file" id="criteriaFileInput" accept=".docx,.doc,.txt,.json,.pdf,.md" hidden>
                            </div>
                            <div id="criteriaFileInfo" class="mt-2 d-none">
                                <div class="alert alert-success mb-0">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <span id="criteriaFileName"></span>
                                    <button type="button" class="btn-close float-end" id="removeCriteriaFile"></button>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <button class="btn btn-outline-secondary btn-sm" id="pasteCriteriaBtn">
                                    <i class="fas fa-paste me-1"></i>Paste Text Instead
                                </button>
                            </div>
                        </div>

                        <!-- DMP Upload -->
                        <div class="mb-3">
                            <label class="form-label">DMP Document to Evaluate</label>
                            <div class="upload-zone" id="dmpUploadZone">
                                <i class="fas fa-file-alt fa-3x mb-3 text-muted"></i>
                                <p class="mb-2">Drag & Drop or Click to Upload</p>
                                <small class="text-muted">Supports: .docx, .doc, .txt, .json, .pdf, .html</small>
                                <input type="file" id="dmpFileInput" accept=".docx,.doc,.txt,.json,.pdf,.html" hidden>
                            </div>
                            <div id="dmpFileInfo" class="mt-2 d-none">
                                <div class="alert alert-success mb-0">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <span id="dmpFileName"></span>
                                    <button type="button" class="btn-close float-end" id="removeDmpFile"></button>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <button class="btn btn-outline-secondary btn-sm" id="pasteDmpBtn">
                                    <i class="fas fa-paste me-1"></i>Paste Text Instead
                                </button>
                            </div>
                        </div>

                        <!-- Evaluate Button -->
                        <button class="btn btn-primary btn-lg w-100" id="evaluateBtn" disabled>
                            <i class="fas fa-play me-2"></i>Start Evaluation
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="col-lg-7 scrollable-column">
                <!-- Status Card -->
                <div class="card mb-4" id="statusCard">
                    <div class="card-body">
                        <div id="statusIdle">
                            <i class="fas fa-info-circle text-info me-2"></i>
                            Upload files and configure API to start evaluation
                        </div>
                        <div id="statusProcessing" class="d-none">
                            <div class="d-flex align-items-center mb-3">
                                <div class="spinner-border spinner-border-sm text-primary me-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div>
                                    <strong>Processing...</strong>
                                    <div id="statusMessage" class="text-muted small"></div>
                                </div>
                            </div>

                            <!-- Streaming Output Display -->
                            <div id="streamingOutputContainer" class="d-none">
                                <!-- Reasoning Section (for reasoning models like DeepSeek-R1) -->
                                <div id="streamingReasoningSection" class="d-none mb-3">
                                    <div class="streaming-section-header">
                                        <i class="fas fa-brain me-2"></i><strong>Model Thinking:</strong>
                                    </div>
                                    <div id="streamingReasoningContent" class="streaming-content reasoning-content"></div>
                                </div>

                                <!-- Response Section -->
                                <div id="streamingResponseSection" class="d-none">
                                    <div class="streaming-section-header">
                                        <i class="fas fa-pen me-2"></i><strong>Response:</strong>
                                    </div>
                                    <div id="streamingResponseContent" class="streaming-content response-content"></div>
                                </div>
                            </div>
                        </div>
                        <div id="statusComplete" class="d-none">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <strong>Evaluation Complete!</strong>
                        </div>
                        <div id="statusError" class="d-none">
                            <i class="fas fa-exclamation-circle text-danger me-2"></i>
                            <strong>Error:</strong> <span id="errorMessage"></span>
                        </div>
                    </div>
                </div>

                <!-- Results Card -->
                <div class="card" id="resultsCard" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Evaluation Results</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" id="exportJsonBtn" title="Export as JSON">
                                <i class="fas fa-file-code"></i> JSON
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="exportMarkdownBtn" title="Export as Markdown">
                                <i class="fab fa-markdown"></i> MD
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="exportPdfBtn" title="Export as PDF">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Overall Score -->
                        <div class="mb-4">
                            <h6>Overall Compliance Score</h6>
                            <div class="progress" style="height: 30px;">
                                <div class="progress-bar" role="progressbar" id="overallScoreBar"
                                     style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    <span id="overallScoreText">0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Scores Table -->
                        <div class="mb-4">
                            <h6>Detailed Scores by Category</h6>
                            <div class="table-responsive">
                                <table class="table table-hover" id="scoresTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 50px;">ID</th>
                                            <th>Category</th>
                                            <th>Criteria</th>
                                            <th style="width: 100px;">Score</th>
                                            <th style="width: 80px;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scoresTableBody">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Narrative Feedback -->
                        <div>
                            <h6>Detailed Feedback</h6>
                            <div id="narrativeFeedback">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Configuration Modal -->
    <div class="modal fade" id="apiConfigModal" tabindex="-1" aria-labelledby="apiConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="apiConfigModalLabel">
                        <i class="fas fa-sliders-h me-2"></i>API Configuration
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Profile Selector -->
                    <div class="mb-4">
                        <label for="apiProfileSelect" class="form-label fw-bold">API Profile</label>
                        <div class="input-group">
                            <select class="form-select" id="apiProfileSelect">
                                <option value="together">Together.ai (Default)</option>
                                <option value="openai">OpenAI Compatible</option>
                                <option value="custom">Custom Configuration</option>
                            </select>
                            <button class="btn btn-outline-danger" type="button" id="deleteProfileBtn" disabled>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <small class="form-text text-muted">Select or create an API configuration profile</small>
                    </div>

                    <!-- API Endpoint -->
                    <div class="mb-3">
                        <label for="apiEndpoint" class="form-label">API Endpoint URL</label>
                        <input type="text" class="form-control" id="apiEndpoint"
                               placeholder="https://api.together.xyz/v1/chat/completions">
                        <small class="form-text text-muted">The complete API endpoint URL</small>
                    </div>

                    <!-- Authorization Header -->
                    <div class="mb-3">
                        <label for="authHeader" class="form-label">Authorization Header Template</label>
                        <input type="text" class="form-control" id="authHeader"
                               placeholder="Bearer {API_KEY}">
                        <small class="form-text text-muted">Use {API_KEY} as placeholder for your API key</small>
                    </div>

                    <!-- Additional Headers -->
                    <div class="mb-3">
                        <label class="form-label">Additional Headers</label>
                        <div id="additionalHeadersContainer">
                            <!-- Dynamic header inputs will be added here -->
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" type="button" id="addHeaderBtn">
                            <i class="fas fa-plus me-1"></i>Add Header
                        </button>
                    </div>

                    <!-- Advanced Parameters -->
                    <div class="accordion mb-3" id="advancedParamsAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#advancedParams">
                                    Advanced Parameters
                                </button>
                            </h2>
                            <div id="advancedParams" class="accordion-collapse collapse"
                                 data-bs-parent="#advancedParamsAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="modelParamName" class="form-label">Model Parameter Name</label>
                                            <input type="text" class="form-control" id="modelParamName"
                                                   placeholder="model" value="model">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="messagesParamName" class="form-label">Messages Parameter Name</label>
                                            <input type="text" class="form-control" id="messagesParamName"
                                                   placeholder="messages" value="messages">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="temperature" class="form-label">Temperature</label>
                                            <input type="number" class="form-control" id="temperature"
                                                   step="0.1" min="0" max="2" value="0.3">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="maxTokens" class="form-label">Max Tokens</label>
                                            <input type="number" class="form-control" id="maxTokens"
                                                   value="8000">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="responseFormat" class="form-label">Response Format</label>
                                            <select class="form-select" id="responseFormat">
                                                <option value="json_object">JSON Object</option>
                                                <option value="text">Text</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Code Preview -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Fetch API Preview</label>
                        <div class="code-preview-container">
                            <pre id="fetchCodePreview" class="code-preview"><code>// Configuration will be previewed here</code></pre>
                        </div>
                        <small class="form-text text-muted">This shows the generated fetch API call configuration</small>
                    </div>

                    <!-- Save as Custom Profile -->
                    <div class="mb-3" id="customProfileNameGroup" style="display: none;">
                        <label for="customProfileName" class="form-label">Save as Custom Profile</label>
                        <input type="text" class="form-control" id="customProfileName"
                               placeholder="Enter profile name">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAPIConfigBtn">
                        <i class="fas fa-save me-1"></i>Save Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Paste Criteria Text Modal -->
    <div class="modal fade" id="pasteCriteriaModal" tabindex="-1" aria-labelledby="pasteCriteriaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pasteCriteriaModalLabel">
                        <i class="fas fa-paste me-2"></i>Paste Evaluation Criteria
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>How it works:</strong> The AI will automatically detect if your text is suitable for evaluation.
                        If not, it will convert it into a proper evaluation prompt.
                    </div>
                    <div class="mb-3">
                        <label for="criteriaTextArea" class="form-label">Paste your evaluation criteria here:</label>
                        <textarea class="form-control font-monospace" id="criteriaTextArea" rows="15"
                                  placeholder="Paste your evaluation criteria document text here..."></textarea>
                        <small class="form-text text-muted">You can paste any format - the system will process it automatically</small>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="useDefaultCriteria">
                        <label class="form-check-label" for="useDefaultCriteria">
                            Use default DMP evaluation criteria (based on Science Europe guidelines)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCriteriaTextBtn">
                        <i class="fas fa-check me-1"></i>Use This Text
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Paste DMP Text Modal -->
    <div class="modal fade" id="pasteDmpModal" tabindex="-1" aria-labelledby="pasteDmpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pasteDmpModalLabel">
                        <i class="fas fa-paste me-2"></i>Paste DMP Document
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Note:</strong> For best results, please ensure your DMP document contains clear sections and structured information.
                    </div>
                    <div class="mb-3">
                        <label for="dmpTextArea" class="form-label">Paste your DMP document here:</label>
                        <textarea class="form-control font-monospace" id="dmpTextArea" rows="15"
                                  placeholder="Paste your DMP document text here..."></textarea>
                        <small class="form-text text-muted">Plain text, markdown, or structured text formats work best</small>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="useExampleDmp">
                        <label class="form-check-label" for="useExampleDmp">
                            Use example DMP document (Alpine Biodiversity Research Project)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveDmpTextBtn">
                        <i class="fas fa-check me-1"></i>Use This Text
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- PDF.js for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Mammoth.js for DOCX parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Application Scripts -->
    <script src="js/file-parser.js"></script>
    <script src="js/criteria-extractor.js"></script>
    <script src="js/api-config.js"></script>
    <script src="js/llm-service.js"></script>
    <script src="js/evaluator.js"></script>
    <script src="js/export-service.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
